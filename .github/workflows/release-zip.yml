name: Create Release ZIP

on:
  workflow_call:
    inputs:
      resumeUrl:
        required: true
        type: string
      project_key:
        required: true
        type: string

      environment:
        required: true
        type: string

      publish_mode:
        required: true
        type: string

      request_id:
        required: true
        type: string

      publisher_email:
        required: true
        type: string

      notes:
        required: false
        type: string

  # Optional: keep this if you want manual runs from GitHub UI
  workflow_dispatch:
    inputs:
      resumeUrl:
        required: true
        type: string
      project_key:
        required: true
        type: string

      environment:
        required: true
        type: choice
        options:
          - prod
          - preprod
          - test

      publish_mode:
        required: true
        type: choice
        options:
          - Immediate
          - Scheduled

      request_id:
        required: true
        type: string

      publisher_email:
        required: true
        type: string

      notes:
        required: false
        type: string

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Set variables
        id: vars
        run: |
          DATE=$(date +'%Y.%m.%d')
          TS=$(date +'%Y%m%d%H%M%S')
          echo "date=$DATE" >> $GITHUB_OUTPUT
          echo "timestamp=$TS" >> $GITHUB_OUTPUT

      - name: Create ZIP
        run: |
          ZIP_NAME="${{ inputs.project_key }}_${{ inputs.environment }}_${{ steps.vars.outputs.timestamp }}.zip"
          zip -r "$ZIP_NAME" . -x ".git/*" ".github/*"

      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "${{ inputs.project_key }}_v${{ steps.vars.outputs.date }}_${{ inputs.environment }}"
          name: "${{ inputs.project_key }} v${{ steps.vars.outputs.date }} (${{ inputs.environment }})"
          body: |
            Request ID: ${{ inputs.request_id }}
            Publisher: ${{ inputs.publisher_email }}
            Environment: ${{ inputs.environment }}
            Publish Mode: ${{ inputs.publish_mode }}
            Notes:
              ${{ inputs.notes }}
          files: |
            *.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract release asset URL
        id: extract_urls
        run: |
          RELEASE_URL="${{ steps.create_release.outputs.url }}"
          ZIP_URL=$(echo '${{ steps.create_release.outputs.assets }}' | jq -r '.[0].browser_download_url')

          echo "release_url=$RELEASE_URL" >> $GITHUB_OUTPUT
          echo "zip_url=$ZIP_URL" >> $GITHUB_OUTPUT

      - name: Resume n8n workflow
        run: |
          curl -X POST "${{ inputs.resumeUrl }}" \
          -H "Content-Type: application/json" \
          -d '{
              "status": "success",
              "request_id": "${{ inputs.request_id }}",
              "release_url": "${{ steps.extract_urls.outputs.release_url }}",
              "zip_url": "${{ steps.extract_urls.outputs.zip_url }}"
              }'

      - name: Resume n8n workflow (failure)
        if: failure()
        run: |
          curl -X POST "${{ inputs.resumeUrl }}" \
          -H "Content-Type: application/json" \
          -d '{
              "status": "failure",
              "request_id": "${{ inputs.request_id }}"
              }'
